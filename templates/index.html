<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analyse de Mouvement</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
  <div class="container">
    <h1 class="title">Je veux m'am√©liorer. Montre-moi comment.</h1>

    <form id="upload-form" method="POST" enctype="multipart/form-data" action="/upload">
      <label for="video-upload" class="upload-button" id="uploadLabel">
        üìÅ T√©l√©verser une vid√©o
        <input type="file" name="video" id="video-upload" accept="video/mp4,video/quicktime" />
      </label>
      
      <!-- Zone de pr√©visualisation de la vid√©o -->
      <div id="videoPreview" class="video-preview-container">
        <video id="previewVideo" class="video-preview" controls>
          Votre navigateur ne supporte pas la lecture vid√©o.
        </video>
        
        <div class="video-info">
          <h3>‚úÖ Vid√©o charg√©e avec succ√®s</h3>
          <div class="video-details">
            <div class="detail-item">
              <span>üìù</span>
              <span id="fileName">Nom du fichier</span>
            </div>
            <div class="detail-item">
              <span>üìè</span>
              <span id="fileSize">Taille du fichier</span>
            </div>
            <div class="detail-item">
              <span>‚è±Ô∏è</span>
              <span id="videoDuration">Dur√©e</span>
            </div>
          </div>
        </div>
        
        <button type="button" class="change-video-btn" id="changeVideoBtn">
          üîÑ Changer de vid√©o
        </button>
      </div>
      
      <!-- Type de mouvement s√©lectionn√© -->
      <div class="motion-type">
        <label for="activity_type" class="form-label">Quel est le type de mouvement analys√© ?</label><br />
        <select name="activity_type" id="activity_type" class="select-input">
          <option value="autre">-- Choisissez une cat√©gorie --</option>
          <option value="basketball">Tir au basket</option>
          <option value="golf">Swing de golf</option>
          <option value="yoga">Posture de yoga</option>
          <option value="squat">Exercice de squat</option>
          <option value="√©quilibre">Test d'√©quilibre</option>

          <!-- NOUVELLES OPTIONS POUR ANALYSE DENSE -->
          <optgroup label="üî¨ Analyse avanc√©e">
            <option value="dense">Analyse dense compl√®te</option>
            <option value="motion_focus">Focus zones de mouvement</option>
            <option value="hybride">Analyse hybride (motion + dense)</option>
            <option value="inspection">Mode inspection</option>
        </optgroup>

          <option value="autre">Autre ou inconnu</option>
        </select>
      </div>

      <div class="upload-status" id="uploadStatus">
        üé¨ Vid√©o pr√™te pour l'analyse !
      </div>
      
      <br /><br />
      <button type="submit" class="submit-button" id="analyzeBtn" disabled>
        üöÄ Analyser ma vid√©o
      </button>
    </form>

    <p class="subtitle">
      Vid√©o personnelle uniquement. Analyse locale. Rien n'est stock√©.
    </p>
  </div>

  <script>
    let videoUpload = document.getElementById('video-upload');
    let selectedFile = null; // Stockage du fichier s√©lectionn√©
    const uploadLabel = document.getElementById('uploadLabel');
    const videoPreview = document.getElementById('videoPreview');
    const previewVideo = document.getElementById('previewVideo');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const uploadStatus = document.getElementById('uploadStatus');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const videoDuration = document.getElementById('videoDuration');
    const changeVideoBtn = document.getElementById('changeVideoBtn');
    const activitySelect = document.getElementById('activity_type');

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDuration(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = Math.floor(seconds % 60);
      return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function checkFormValidity() {
      const hasFile = selectedFile !== null;
      const hasActivity = activitySelect.value !== '';
      
      if (hasFile && hasActivity) {
        analyzeBtn.disabled = false;
        analyzeBtn.classList.add('enabled');
        analyzeBtn.innerHTML = 'üöÄ Analyser cette vid√©o';
        analyzeBtn.style.animation = 'pulse 2s infinite';
      } else {
        analyzeBtn.disabled = true;
        analyzeBtn.classList.remove('enabled');
        analyzeBtn.innerHTML = 'üöÄ Analyser ma vid√©o';
        analyzeBtn.style.animation = 'none';
      }
    }

    function handleVideoUpload(e) {
      const file = e.target.files[0];
      
      if (file) {
        console.log('Fichier s√©lectionn√©:', file.name);
        
        // V√©rifier le type de fichier
        const validTypes = ['video/mp4', 'video/quicktime', 'video/x-msvideo'];
        if (!validTypes.includes(file.type)) {
          alert('Format de fichier non support√©. Utilisez MP4 ou MOV.');
          e.target.value = '';
          selectedFile = null;
          checkFormValidity();
          return;
        }

        // V√©rifier la taille du fichier (limite √† 100MB)
        if (file.size > 100 * 1024 * 1024) {
          alert('Fichier trop volumineux. Limite de 100MB.');
          e.target.value = '';
          selectedFile = null;
          checkFormValidity();
          return;
        }

        // Stocker le fichier
        selectedFile = file;

        // Cr√©er une URL pour la pr√©visualisation
        const videoURL = URL.createObjectURL(file);
        previewVideo.src = videoURL;
        
        // Afficher les informations du fichier
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        
        // Attendre que les m√©tadonn√©es soient charg√©es pour obtenir la dur√©e
        previewVideo.addEventListener('loadedmetadata', function() {
          videoDuration.textContent = formatDuration(previewVideo.duration);
        }, { once: true });
        
        // Afficher la zone de pr√©visualisation
        videoPreview.classList.add('show');
        uploadStatus.classList.add('success');
        
        // Changer le texte du bouton d'upload
        uploadLabel.innerHTML = '‚úÖ Vid√©o charg√©e<input type="file" name="video" id="video-upload" accept="video/mp4,video/quicktime" />';
        
        // R√©attacher l'√©v√©nement au nouvel input
        videoUpload = document.getElementById('video-upload');
        videoUpload.addEventListener('change', handleVideoUpload);
        
        // V√©rifier la validit√© du formulaire
        checkFormValidity();
      }
    }

    function changeVideo() {
      console.log('Changement de vid√©o demand√©');
      
      // R√©initialiser tout
      selectedFile = null;
      videoPreview.classList.remove('show');
      uploadStatus.classList.remove('success');
      
      // R√©initialiser le label d'upload
      uploadLabel.innerHTML = 'üìÅ T√©l√©verser une vid√©o<input type="file" name="video" id="video-upload" accept="video/mp4,video/quicktime" />';
      
      // R√©attacher l'√©v√©nement au nouvel input
      videoUpload = document.getElementById('video-upload');
      videoUpload.addEventListener('change', handleVideoUpload);
      
      // Nettoyer l'URL de pr√©visualisation
      if (previewVideo.src) {
        URL.revokeObjectURL(previewVideo.src);
        previewVideo.src = '';
      }
      
      // V√©rifier la validit√© du formulaire
      checkFormValidity();
    }

    // V√©rifier la validit√© quand l'activit√© change
    activitySelect.addEventListener('change', checkFormValidity);

    // Attacher les √©v√©nements initiaux
    videoUpload.addEventListener('change', handleVideoUpload);
    changeVideoBtn.addEventListener('click', changeVideo);

    // Gestion de la soumission du formulaire
    document.getElementById('upload-form').addEventListener('submit', function(e) {
      console.log('Tentative de soumission du formulaire');
      
      // V√©rifications avant soumission
      if (!selectedFile) {
        e.preventDefault();
        alert('Veuillez d\'abord s√©lectionner une vid√©o.');
        return false;
      }
      
      if (!activitySelect.value) {
        e.preventDefault();
        alert('Veuillez s√©lectionner un type d\'activit√©.');
        return false;
      }
      
      // S'assurer que le fichier est bien dans l'input
      const currentFileInput = document.getElementById('video-upload');
      if (!currentFileInput.files || currentFileInput.files.length === 0) {
        console.log('R√©attachement du fichier √† l\'input');
        // Cr√©er un nouveau FileList avec notre fichier stock√©
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(selectedFile);
        currentFileInput.files = dataTransfer.files;
      }
      
      console.log('Formulaire soumis - analyse en cours...');
      
      // D√©sactiver le bouton pour √©viter les doubles soumissions
      analyzeBtn.disabled = true;
      analyzeBtn.innerHTML = '‚è≥ Envoi en cours...';
      
      return true;
    });

    // V√©rification initiale
    checkFormValidity();
  </script>
</body>
</html>